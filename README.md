# Лизни и Пролистни (Lick Scroll)

MVP для инновационной 18+ платформы - гибрид TikTok и OnlyFans.

## Описание

Платформа для публикации и монетизации контента 18+ от реальных креаторов и AI-генераций. Пользователи могут просматривать контент, подписываться на креаторов, покупать отдельные посты за внутреннюю валюту.

## Архитектура

Проект построен на микросервисной архитектуре с использованием Go и следует принципам Clean Architecture. Система состоит из 7 независимых микросервисов, каждый из которых отвечает за свою область функциональности.

### Clean Architecture

Все сервисы следуют единой архитектурной структуре:
- **Entity** - чистые бизнес-сущности без зависимостей от инфраструктуры
- **Model** - GORM модели для работы с базой данных
- **Mapper** - преобразование между Entity и Model
- **Repository** - слой доступа к данным
- **UseCase** - бизнес-логика и оркестрация
- **Handler** - HTTP обработчики запросов

### Архитектурная схема

```
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway (Nginx)                       │
│                 Единая точка входа                           │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│ User Service │      │ Post Service │      │ Feed Service │
│   :8001      │      │   :8002      │      │   :8003      │
│              │      │              │      │              │
└──────────────┘      └──────────────┘      └──────────────┘
        ▲                     │                     │
        │                     │                     │
        │                     ▼                     │
        │              ┌──────────────┐             │
        │              │Interaction   │             │
        │              │Service:8007  │             │
        │              │(Likes/Views) │             │
        │              └──────────────┘             │
        │                     │                     │
        │                     ▼                     │
        │              ┌──────────────┐             │
        │              │ Post Service │             │
        │              │→ RabbitMQ    │             │
        │              │  (publish)   │             │
        │              └──────────────┘             │
        │                     │                     │
        │                     ├─────────────────────┐
        │                     ▼                     ▼
        │              ┌──────────────┐      ┌──────────────┐
        │              │RabbitMQ      │      │Notification  │
        │              │   Queue      │◄─────│  Service:8006│
        │              │  (events)    │      │  (consume)   │
        │              └──────────────┘      └──────────────┘
        │                     ▲                     │
        │                     │                     │
        │                     │               (WebSocket)
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│Interaction   │      │Wallet Service│      │Notification  │
│Service:8007  │      │   :8005      │      │  Service:8006│
└──────────────┘      └──────────────┘      └──────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│Analytics     │      │              │      │              │
│Service:8008  │      │              │      │              │
└──────────────┘      └──────────────┘      └──────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
   ┌────────┐  ┌──────┐   ┌────────┐         ┌─────────────┐
   │Postgres│  │Redis │   │ MinIO  │         │  RabbitMQ   │
   │   DB   │  │Cache │   │  S3    │         │   Queue     │
   └────────┘  └──────┘   └────────┘         └─────────────┘
        ▲                     ▲                     ▲
        │                     │                     │
        └─────────────────────┴─────────────────────┘
                  (используют все сервисы)
```

### Поток публикации поста

```
1. Creator → API Gateway → Post Service (8002)
   ├─ Аутентификация через User Service (8001)
   ├─ Загрузка медиа в MinIO/S3
   ├─ Сохранение в PostgreSQL
   └─ Кэширование в Redis

2. Post Service → RabbitMQ (публикация события "новый пост")
   └─ Отправка события в очередь для Notification Service

3. RabbitMQ → Notification Service (8006) (потребление события)
   ├─ Получение списка подписчиков из User Service
   └─ Создание уведомлений для подписчиков через WebSocket
```

### Поток формирования ленты

```
1. User → API Gateway → Feed Service (8003)
   └─ Аутентификация через User Service (8001)

2. Feed Service → User Service (8001) - запрос подписок
   └─ Получение списка подписок пользователя

3. Feed Service → PostgreSQL (прямой запрос)
   ├─ Получение постов от авторов из подписок
   └─ Получение остальных постов

4. Feed Service → Redis Cache (проверка кэша)
   └─ Если кэш актуален, возврат из кэша

5. Feed Service → Сортировка по времени
   └─ Объединение постов от подписок + остальные посты

6. Feed Service → Redis Cache (обновление кэша)
   └─ Сохранение ленты в кэш (TTL 10 минут)

7. Feed Service → User
   └─ Возврат персональной ленты
```


### Сервисы

1. **User Service** (порт 8001, бывший Auth Service) - Аутентификация и управление пользователями
   - Регистрация и вход пользователей
   - Генерация и валидация JWT токенов
   - Управление ролями (viewer, creator)
   - Управление подписками
   - Загрузка аватаров в MinIO/S3

2. **Post Service** (порт 8002) - Управление контентом
   - CRUD операции с постами
   - Загрузка медиафайлов (фото/видео) в MinIO/S3
   - Кэширование постов в Redis
   - Публикация событий в RabbitMQ при создании поста
   - Поддержка до 10 изображений на пост
   - Автоматическое определение типа поста (photo/video)

3. **Feed Service** (порт 8003) - Формирование персональной ленты
   - Запрос подписок из User Service
   - Получение последних постов от авторов из PostgreSQL
   - Сортировка постов по времени (подписки первыми)
   - Объединение постов от подписок с остальными постами
   - Кэширование лент в Redis (TTL 10 минут)

4. **Interaction Service** (порт 8007) - Взаимодействия с контентом
   - Лайки постов (toggle - лайк/снятие лайка)
   - Подсчет просмотров (один раз на пользователя)
   - Получение списка понравившихся постов
   - Публикация событий в RabbitMQ при лайках
   - Кэширование счетчиков в Redis

5. **Wallet Service** (порт 8005) - Управление внутренней валютой и покупками
   - Управление балансом кошелька
   - Покупка постов за внутреннюю валюту
   - История транзакций

6. **Notification Service** (порт 8006) - Push-уведомления
   - Подписка на события через RabbitMQ (новый пост, новый лайк, подписка)
   - WebSocket для real-time уведомлений
   - Получение уведомлений пользователя (пагинация)
   - Управление настройками уведомлений (включение/отключение по креатору)
   - Хранение уведомлений в Redis (последние 100)
   - Автоматическая обработка очереди событий

7. **Analytics Service** (порт 8008) - Аналитика для креаторов
   - Статистика по просмотрам и покупкам
   - Доходы креаторов
   - Аналитика по отдельным постам

### Инфраструктура

- **API Gateway (Nginx)** - единая точка входа, маршрутизация запросов к микросервисам
- **PostgreSQL** - основная база данных для хранения пользователей, постов, транзакций
- **Redis** - кэширование лент, rate limiting, хранение уведомлений
- **MinIO/S3** - хранение медиафайлов (фото и видео)
- **RabbitMQ** - очередь сообщений для асинхронной обработки событий (новый пост, лайк, и т.д.)
- **WebSocket** - real-time уведомления через Notification Service
- **Docker** - контейнеризация всех сервисов
- **Docker Compose** - оркестрация для локальной разработки

## Требования

- Go 1.21+
- Docker и Docker Compose

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd lick-scroll
```

### 2. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
# JWT Secret (обязательно измените в production!)
JWT_SECRET=your-super-secret-jwt-key-change-in-production

# S3 (для загрузки медиа)
S3_BUCKET_NAME=lick-scroll-content
```

### 3. Запуск через Docker Compose

```bash
docker-compose up -d
```

Это запустит все сервисы и зависимости (PostgreSQL, Redis).

### 4. Проверка работоспособности

Проверьте health check каждого сервиса:

```bash
curl http://localhost:8001/health  # User Service
curl http://localhost:8002/health  # Post Service
curl http://localhost:8003/health  # Feed Service
curl http://localhost:8007/health  # Interaction Service
curl http://localhost:8005/health  # Wallet Service
curl http://localhost:8006/health  # Notification Service
curl http://localhost:8008/health  # Analytics Service
```

## Swagger Documentation

Каждый сервис имеет Swagger/OpenAPI документацию, доступную через веб-интерфейс:

- **User Service**: http://localhost:8001/swagger/index.html
- **Post Service**: http://localhost:8002/swagger/index.html
- **Feed Service**: http://localhost:8003/swagger/index.html
- **Interaction Service**: http://localhost:8007/swagger/index.html
- **Wallet Service**: http://localhost:8005/swagger/index.html
- **Notification Service**: http://localhost:8006/swagger/index.html
- **Analytics Service**: http://localhost:8008/swagger/index.html

Для генерации документации используйте скрипт:
```bash
./scripts/generate-swagger.sh
```

Или вручную для каждого сервиса:
```bash
cd services/<service-name>
swag init -g main.go --output docs
```

## Структура проекта

```
lick-scroll/
├── pkg/                    # Общие пакеты
│   ├── config/            # Конфигурация
│   ├── database/          # Подключение к БД
│   ├── jwt/               # JWT сервис
│   ├── middleware/        # HTTP middleware (auth, rate limit)
│   ├── s3/                # S3/MinIO клиент
│   ├── logger/            # Логирование
│   └── queue/             # RabbitMQ клиент
├── services/              # Микросервисы
│   ├── auth/             # User Service (аутентификация и авторизация)
│   │   ├── internal/
│   │   │   ├── entity/   # Бизнес-сущности
│   │   │   ├── model/     # GORM модели
│   │   │   ├── repo/      # Репозитории
│   │   │   ├── usecase/   # Бизнес-логика
│   │   │   └── controller/http/  # HTTP handlers
│   ├── post/             # Post Service (управление контентом)
│   ├── feed/             # Формирование персональной ленты
│   ├── interaction/      # Взаимодействия (лайки, просмотры)
│   ├── wallet/           # Управление кошельками
│   ├── notification/     # Push-уведомления (WebSocket, RabbitMQ)
│   └── analytics/        # Аналитика
├── migrations/           # SQL миграции
├── cmd/                 # CLI утилиты (migrate, seed)
├── frontend/            # React фронтенд приложение
├── docker-compose.yml   # Docker Compose конфигурация
├── Makefile            # Команды для разработки
├── test_coverage.sh    # Скрипт для проверки покрытия тестами
└── README.md
```

## Бизнес-логика

### Процесс публикации поста

1. Креатор загружает контент через API Gateway → Post Service
2. Контент сохраняется в MinIO/S3
3. Пост создается и сохраняется в PostgreSQL
4. Пост кэшируется в Redis
5. Post Service публикует событие "новый пост" в RabbitMQ
6. Notification Service получает событие из RabbitMQ
7. Notification Service получает список подписчиков из User Service
8. Notification Service отправляет уведомления подписчикам через WebSocket

### Процесс формирования ленты

1. Пользователь запрашивает ленту через API Gateway → Feed Service
2. Feed Service проверяет кэш в Redis, если есть - возвращает из кэша
3. Feed Service запрашивает список подписок из User Service
4. Feed Service запрашивает последние посты от авторов из PostgreSQL
5. Feed Service запрашивает остальные посты из PostgreSQL
6. Feed Service сортирует посты по времени (подписки первыми)
7. Feed Service объединяет посты от подписок с остальными постами
8. Feed Service сохраняет ленту в Redis кэш (TTL 10 минут)
9. Feed Service возвращает персональную ленту пользователю

### Покупка поста

1. Пользователь запрашивает покупку через Wallet Service
2. Проверяется баланс кошелька
3. Если достаточно средств, баланс списывается
4. Создается транзакция
5. Пользователь получает доступ к контенту

## Разработка

### Локальная разработка

Для разработки без Docker:

```bash
# Установка зависимостей
go mod download

# Запуск PostgreSQL и Redis (через Docker)
docker-compose up -d postgres redis

# Запуск сервиса (например, auth)
cd services/auth
go run main.go
```

### Тестирование

Проект имеет покрытие тестами более 30% кодовой базы. Все тесты покрывают критический бизнес-функционал.

#### Запуск всех тестов

```bash
# Запуск всех тестов
make test

# Запуск всех тестов с подробным выводом
make test-v

# Запуск тестов с проверкой покрытия
make coverage

# Или через скрипт
./test_coverage.sh
```

#### Структура тестов

Тесты организованы по сервисам и покрывают:
- Unit тесты для UseCase слоя
- Integration тесты для Repository слоя
- Mock тесты для HTTP handlers
- Тесты для бизнес-логики и валидации
